local isProcessing = false
local lastTriggerTime = 0
local DEBOUNCE_MS = 100  -- Minimum ms between triggers

local function focusVSCodeWindow(n)
    local app = hs.application.get("com.microsoft.VSCode")
    if not app then
        hs.alert.show("VSCode not running")
        return
    end

    local windows = app:allWindows()
    
    table.sort(windows, function(a, b)
        return a:id() < b:id()
    end)

    if #windows == 0 then
        hs.alert.show("No VSCode windows")
        return
    end

    if n > #windows then
        hs.alert.show("Only " .. #windows .. " VSCode window(s)")
        return
    end

    local win = windows[n]
    win:focus()
end

local keycodes = {
    [18] = 1,
    [19] = 2,
    [20] = 3,
    [21] = 4,
    [23] = 5,
    [22] = 6,
}

local vscodeSwitcher = nil

local function createEventTap()
    if vscodeSwitcher then
        vscodeSwitcher:stop()
    end
    
    vscodeSwitcher = hs.eventtap.new({hs.eventtap.event.types.keyDown}, function(event)
        local keycode = event:getKeyCode()
        local flags = event:getFlags()
        
        if flags.cmd and flags.ctrl and not flags.alt and not flags.shift then
            local windowNum = keycodes[keycode]
            if windowNum then
                local now = hs.timer.secondsSinceEpoch() * 1000
                
                -- Debounce and prevent overlapping calls
                if isProcessing or (now - lastTriggerTime) < DEBOUNCE_MS then
                    return true
                end
                
                lastTriggerTime = now
                isProcessing = true
                
                hs.timer.doAfter(0, function()
                    pcall(function()
                        focusVSCodeWindow(windowNum)
                    end)
                    isProcessing = false
                end)
                
                return true
            end
        end
        
        return false
    end)
    
    vscodeSwitcher:start()
    return vscodeSwitcher
end

-- Create initial eventtap
createEventTap()

-- Watchdog: restart eventtap if it stops running
hs.timer.doEvery(5, function()
    if not vscodeSwitcher or not vscodeSwitcher:isEnabled() then
        print("Restarting VSCode switcher eventtap")
        createEventTap()
    end
    -- Reset stuck processing flag
    isProcessing = false
end)